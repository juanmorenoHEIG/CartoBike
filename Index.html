<html>

<head>
    <meta charset="UTF-8" />

    <title>CartoBike</title>

    <link href="css/style.css" type="text/css" rel="stylesheet">

    <script type="text/javascript" src="js/config.js"></script>

    <script type="text/javascript">
        var map;

        $(document).ready(function() {
            doGetMapRequests();
        });

        var imgSet = [
            'Aerial',
            'AerialWithLabels'
        ];

        var imgSetValue = 0;


        function doGetMapRequests() {
            /*-------------------------------------------
            Ex 1 — Première couche de référence: Satellite map
            -------------------------------------------*/
            var satelliteMap = new ol.layer.Tile({
                title: 'SatelliteMap',
                type: "base",
                source: new ol.source.BingMaps({
                    key: 'AqE05oJsq-bWa50FPOW2S0eQm9Oqqygc1VTi_WPhUIoKR_-jgA559CRbfndgWAIz',
                    imagerySet: imgSet[imgSetValue],
                    wrapX: false
                })
            });

            /*-------------------------------------------
            Ex 1 — Deuxième couche de référence: Frontière de la Suisse
            -------------------------------------------*/
            // style ne fonctionne pas!!!
            // => http://www.rhone-mediterranee.eaufrance.fr/milieux-aquatiques/poissons/js/openlayers-v3.19.1/apidoc/ol.layer.Tile.html
            var frontiereSuisseStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#004000',
                    width: 1
                })
            });
            var frontiereSuisse = new ol.layer.Tile({
                title: "FrontiereSuisse",
                source: new ol.source.TileWMS({
                    url: "https://wms.geo.admin.ch",
                    params: {
                        VERSION: "1.1.1",
                        LAYERS: "ch.swisstopo.swissboundaries3d-land-flaeche.fill",
                        FORMAT: "image/png"
                    }
                }),
                style: frontiereSuisseStyle,
                //opacity: 0.5
            });

            // Centre au milieu de la Suisse
            var center = ol.proj.transform([8.2, 46.8], 'EPSG:4326', 'EPSG:3857');
            var view = new ol.View({
                center: center,
                zoom: 7.7
            });

            map = new ol.Map({
                target: 'map',
                layers: [
                    satelliteMap,
                    frontiereSuisse
                ],
                loadTilesWhileInteracting: true,
                view: view
            });


            /*-------------------------------------------
            Ex 2 — Deuxième couches en superpositions qui viennent enrichir la visualisation en pertinence avec la thématique: Pistes cyclables
            -------------------------------------------*/
            // trouver seulement pour Zurich


            /*-------------------------------------------
            Ex 2 — Troisième couches en superpositions qui viennent enrichir la visualisation en pertinence avec la thématique: Routes (voiture)
            -------------------------------------------*/


            /*-------------------------------------------
            Ex 3 — Première couche en super superposition de type vector et les possibilités d'interaction avec celle-ci
            -------------------------------------------*/
            var q = "select*from%20public.ch_bfe_bikesharing_fr";
            var fromat = "GeoJSON";
            var key = "a1a59d709941fb82f30fafa226924d04a23ba185";

            function createBikeShareStyle(feature, resolution) {
                var styleBikeShare = new ol.style.Style({
                    image: new ol.style.Icon({
                        src: "https://data.geo.admin.ch/ch.bfe.bikesharing/images/" + feature.get('idsystem') + "_bike.png",
                        anchor: [0.5, 1]
                    })
                });
                console.log(feature.get('idsystem'));
                return styleBikeShare;
            };
            var bikeLyr = new ol.layer.Vector({
                title: "BikeSharing",
                source: new ol.source.Vector({
                    url: "https://juanmorenoheig.carto.com/api/v2/sql?q=" + q + "&format=" + fromat + "&api_key=" + key,
                    format: new ol.format.GeoJSON()
                }),
                style: createBikeShareStyle
            });
            map.addLayer(bikeLyr);
            // Event sur click sur un bike pour afficher info
            var selectInteraction = new ol.interaction.Select({
                condition: ol.events.condition.singleClick,
                // the interactive layers on which the selection is possible (they may be more than one)
                layers: [bikeLyr]
            });
            map.addInteraction(selectInteraction);
            // add a listener to fire when one or more feature from the interactive layer(s) is(are) selected
            selectInteraction.on('select', function(e) {
                if (e.selected.length > 0) {
                    var desc = e.selected[0].get("description");
                    $("#info").html(desc);
                } else {
                    $("#info").html("Select icon on the map to get feature info");
                }
            });
        }

        /*-------------------------------------------
        Ex 1 — Première couche de référence à choix pour l'utilisateur: Satellite map
        -------------------------------------------*/
        function streetOn() {
            if (imgSetValue != 1) {
                document.getElementById("change").innerHTML = '<div id="map"></div>';
                document.getElementById("name").innerHTML = 'Streetnames <button onclick="streetOn()" disabled="disabled" id="clicked">On</button> <button onclick="streetOff()">Off</button>';
                imgSetValue = 1;
                doGetMapRequests();
            }
        }

        function streetOff() {
            if (imgSetValue != 0) {
                document.getElementById("change").innerHTML = '<div id="map"></div>';
                document.getElementById("name").innerHTML = 'Streetnames <button onclick="streetOn()">On</button> <button onclick="streetOff()" disabled="disabled" id="clicked">Off</button>';
                imgSetValue = 0;
                doGetMapRequests();
            }
        }

    </script>
</head>

<body>
    <header>
        <h1>CartoBike</h1>
        <p>This application is intended for users of rental bicycles.</p>
    </header>

    <div class="container">
        <div class="left">
            <h3 class="containerHead">Map</h3>
            <div class="containerContent" id="change">
                <div id="map"></div>
            </div>
        </div>

        <div class="right">
            <h3 class="containerHead">Settings</h3>
            <div class="containerContent">
                <p id="name">
                    Streetnames
                    <button onclick="streetOn()">On</button>
                    <button onclick="streetOff()" disabled="disabled" id="clicked">Off</button>
                </p>
                <p id="velo">
                    Cycle paths
                    <button onclick="veloOn()">On</button>
                    <button onclick="veloOff()">Off</button>
                </p>
                <p id="street">
                    Streets
                    <button onclick="streetOn()">On</button>
                    <button onclick="streetOff()">Off</button>
                </p>
            </div>
        </div>

        <div class="right">
            <h3 class="containerHead">Informations</h3>
            <div class="containerContent">
                <div id="info">Select icon on the map to get feature info</div>
            </div>
        </div>

    </div>

    <footer>
        <p>Application by Juan Moreno and Stefanie Schlumpf | GÉOINF 18/19</p>
    </footer>
</body>

</html>
