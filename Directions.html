<html>
    <head>
        <title>ol3 - EXA-Phase2 - Directions</title>
        <script type="text/javascript" src="js/config.js"></script>
        <script type="text/javascript">
            var map, vectorLayer;
            var token = "pk.eyJ1Ijoib2VydHoiLCJhIjoiT29aUVYyRSJ9.mz-_gaaigdhurQPHZf7fig";

            $(document).ready(function () {
                // Create map with OSM baselayer / centered on the East of the NeuchÃ¢tel lake
                map = new ol.Map({
                    view: new ol.View({
                        center: [766225, 5908730],
                        zoom: 12
                    }),
                    target: 'map',
                    layers: [
                        new ol.layer.Tile({
                            opacity: 1, // !!
                            source: new ol.source.OSM()
                        })
                    ]
                });
                
                vectorLayer = new ol.layer.Vector({
                    source: new ol.source.Vector(), // empty source
                    style: new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: '#ff0000',
                            width: 2
                        })
                    })
                });
                map.addLayer(vectorLayer);
                initRoute();

                map.on("singleclick", function (e) {
                    var fts = vectorLayer.getSource().getFeatures();
                    fts[0].getGeometry().appendCoordinate(e.coordinate);
                    console.log("fts: " + fts);
                });

                $("#route").click(function (e) {
                    // interact with Mapbox Directions API given all the segments of the requested route
                    var fts = vectorLayer.getSource().getFeatures();
                    if (fts[0].getGeometry().getLength() >= 2) {
                        console.log(fts[0]);
                        ft = fts[0].getGeometry().clone().transform("EPSG:3857", "EPSG:4326");
                        console.log(ft);
                        var s = ft.getCoordinates().join(";");
                        console.log(s);

                        var url = "https://api.mapbox.com/v4/directions/mapbox.walking/" + s + ".json?access_token=" + token;
                        $.get(url, function (data) {
                            $("#info").append($("<p/>").text(data.origin.properties.name + " --> " + data.destination.properties.name));

                            var geom = new ol.geom.LineString(data.routes[0].geometry.coordinates);
                            var ft = new ol.Feature({
                                geometry: geom.transform("EPSG:4326", "EPSG:3857"),
                                name: "Route 1"
                            });
                            vectorLayer.getSource().addFeature(ft);
                            var fts = vectorLayer.getSource().getFeatures();
                            fts[0].getGeometry().setCoordinates([]);
                        });
                    }
                });

                $("#reset").click(function (e) {
                    vectorLayer.getSource().clear();
                    $("#info p").remove();
                    initRoute();
                });
            });
            
            function initRoute(){
                // Just add a first empty LineString
                var geom = new ol.geom.LineString([]);
                var ft = new ol.Feature({
                    geometry: geom,
                    name: "Input feature"
                });
                vectorLayer.getSource().addFeature(ft);
            }
        </script>

        <style type="text/css">
            #map {
                width: 100%;
                height: 100%;
            }

            #info {
                position: absolute;
                top: 15px;
                right: 15px;
                background-color: #fff;
                padding: 5px;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <div id="info">
            <img id="route" src="https://maps.gstatic.com/tactile/omnibox/directions-1x-20150909.png"/>
            <img id="reset" src="https://cdn2.iconfinder.com/data/icons/diagona/icon/16/101.png"/>
        </div>
    </body>
</html>